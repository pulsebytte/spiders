import os
from google.cloud import storage
import requests
import pandas as pd


os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "D:\MyBuild\GCP\pulsebyttedatawork-b1df70745eae.json"


def store_api_data(api_url, bucket_name, blob_name):

    try:
        response = requests.get(api_url)
        if response.status_code == 200:
            print("API Request Successful")
            data = response.json()
        else:
            print("Error", response.status_code, response.text)
            raise Exception("API Request Failed")
        
        df = pd.DataFrame(data)

        csv_data = df.to_csv(index=False)

        storage_client = storage.Client()
        bucket = storage_client.bucket(bucket_name)

        blob = bucket.blob(blob_name)
        blob.upload_from_string(csv_data)

        print(f'Data Store As CSV file: {blob.name}')

    except Exception as e:
        print("Error:", e)


api_url = "https://fakestoreapi.com/products"
bucket_name = "my-valid-bronze-bucket-name"
blob_name = "e-commerce-data.csv"

store_api_data(api_url, bucket_name, blob_name)
